// scripts/import-chain-data.js
// Script to convert data.json to SQL INSERT statements
// Run with: node scripts/import-chain-data.js

const fs = require('fs');
const path = require('path');

// Parse numbers with commas (e.g., "2,791" -> 2791)
function parseNumber(value) {
    return parseInt(value.replace(/,/g, ''), 10) || 0;
}

// Escape single quotes for SQL
function escapeSql(str) {
    return str.replace(/'/g, "''");
}

function main() {
    // Read data.json
    const dataPath = path.join(__dirname, '..', 'data.json');
    const rawData = fs.readFileSync(dataPath, 'utf-8');
    const data = JSON.parse(rawData);

    // Flatten all lists into one array
    const allTargets = [];
    const seenIds = new Set();

    for (const listName of Object.keys(data)) {
        const list = data[listName];
        for (const target of list) {
            // Skip duplicates
            if (seenIds.has(target.id)) continue;
            seenIds.add(target.id);
            allTargets.push(target);
        }
    }

    console.log(`Total unique targets: ${allTargets.length}`);

    // Generate SQL
    let sql = `-- Generated by import-chain-data.js
-- Total targets: ${allTargets.length}
-- Run after 20260122_chain_targets.sql migration

INSERT INTO chain_target (torn_id, name, level, total_stats, strength, defense, speed, dexterity, status) VALUES
`;

    const values = allTargets.map(t => {
        const tornId = parseInt(t.id, 10);
        const name = escapeSql(t.name);
        const level = parseNumber(t.lvl);
        const total = parseNumber(t.total);
        const str = parseNumber(t.str);
        const def = parseNumber(t.def);
        const spd = parseNumber(t.spd);
        const dex = parseNumber(t.dex);
        return `(${tornId}, '${name}', ${level}, ${total}, ${str}, ${def}, ${spd}, ${dex}, 'Unknown')`;
    });

    sql += values.join(',\n');
    sql += `
ON CONFLICT (torn_id) DO UPDATE SET
    name = EXCLUDED.name,
    level = EXCLUDED.level,
    total_stats = EXCLUDED.total_stats,
    strength = EXCLUDED.strength,
    defense = EXCLUDED.defense,
    speed = EXCLUDED.speed,
    dexterity = EXCLUDED.dexterity;
`;

    // Write output
    const outputPath = path.join(__dirname, '..', 'supabase', 'migrations', '20260122_import_chain_data_full.sql');
    fs.writeFileSync(outputPath, sql);
    console.log(`SQL written to: ${outputPath}`);
}

main();
